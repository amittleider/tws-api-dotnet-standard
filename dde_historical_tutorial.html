<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>TWS API v9.72+: Historical Data with Excel</title>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="https://www.interactivebrokers.com/favicon.ico" rel="shortcut icon">
<script>
$(document).ready(function(){
		var picked=getCookie("picked");
		if (picked != "") {
			if (!$(this).hasClass("active")) {
				var tabNum = $(this).index();
				var nthChild = picked;
				$("ul#tabs li.active").removeClass("active");
				$(this).addClass("active");
				$("ul#tab li.active").removeClass("active");
				$("ul#tab li:nth-child("+nthChild+")").addClass("active");
				$("ul#tabs li:nth-child("+nthChild+")").addClass("active");
				setCookie("picked", nthChild, 1);
			}
		}
		$("ul#tabs li").click(function(e){
			if (!$(this).hasClass("active")) {
			var tabNum = $(this).index();
			var nthChild = tabNum+1;
			$("ul#tabs li.active").removeClass("active");
			$(this).addClass("active");
			$("ul#tab li.active").removeClass("active");
			$("ul#tab li:nth-child("+nthChild+")").addClass("active");
			setCookie("picked", nthChild, 1);
		}
    });
});
function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
} 
function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
} 
function checkCookie() {
    var picked=getCookie("picked");
    if (picked != "") {
        alert("Welcome again " + picked);
    }else{
        //username = prompt("Please enter your name:", "");
        if (picked != "" && picked != null) {
            setCookie("picked", 1, 365);
        }
    }
}
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ib_theme.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" style="background-color:black;">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr>
  <td id="projectlogo"><img alt="Logo" src="nav_iblogo.png"/></a></td>
  <td style="padding: 0 0 0 1em;">
   <ul id="tabs"><li class="active">C#</li><li>Java</li><li>VB</li><li>C++</li><li>Python</li></ul>
  </td>
  <td><a href="https://www.interactivebrokers.com/en/index.php?f=customerService&p=email" style="color:#C7C7C7;font-weight:bold;padding: 0 0 0 1em;">Contact us</a></td>
  <!--BEGIN GCS_SEARCHBOX-->
  <td style="position: absolute; right: 0;">
   <div id="google-custom-search" align="right" style="vertical-align: top;">
   <script>
  (function() {
    var cx = '002885114636493240026:q6smajphkxq';
	var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
	</script>
	<gcse:search newWindow="false" enableHistory="true"></gcse:search>
   </div>
   </td>
  <!--END !GCS_SEARCHBOX-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dde_historical_tutorial.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Historical Data with Excel </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In the previous tutorial, we showed you how to request real time quotes from TWS using the DDE TWS API. In this tutorial, we will show you how to request historical data from TWS, although the process for doing so is slightly more complicated. You will need to add some simple Visual Basic (VBA) code to your Excel worksheet to obtain the data.</p>
<h1><a class="anchor" id="dde_hst_requisites"></a>
Requisites</h1>
<p>Please make sure you have already acquired <a class="el" href="dde_tutorial.html#dde_what_you_will_need">What You Will Need</a> before going forward in this tutorial.</p>
<h1><a class="anchor" id="dde_hst_prepare"></a>
Preparing the request</h1>
<p>Just as with real time data, historical data requests need first to ask the TWS to “prepare” the data we are interested in. The TWS needs to know not only the specific instrument but also:</p>
<ul>
<li>The ending date and time from which we want to collect the data, formatted as: <b>yyyymmdd hh:mm:ss</b>.</li>
<li>The time duration comprising the data from the ending date going back in time.</li>
<li>The bar size (IB provides historical data in open, high, low and close bar data format).</li>
<li>The type of data (i.e. MIDPOINT, TRADES, etc.).</li>
<li>Whether we want data generated during regular trading session or not.</li>
<li>The date format in which each bar’s time and date will be presented.</li>
</ul>
<p>The formula to be used for historical data requests is:</p>
<p><b>=[twsuser]|hist!'id[requestId]?req?[symbol]_[type]_[exchange]_[currency]_~/[yyyymmdd]singleSpace[HH]singleColon[mm]singleColon[ss]_[duration amount]singleSpace[duration unit]_[bar size]_[rth only?]_[what to show]_[date format]'</b></p>
<table class="doxtable">
<tr>
<th><b>Attribute</b></th><th><b>Description</b> </th></tr>
<tr>
<td>twsuser</td><td>The username with which you logged into TWS. </td></tr>
<tr>
<td>requestId</td><td>The request’s unique identifier (any positive integer). </td></tr>
<tr>
<td>symbol</td><td>The instrument’s symbol. </td></tr>
<tr>
<td>type</td><td>The type of instrument. </td></tr>
<tr>
<td>exchange</td><td>The instrument’s exchange. </td></tr>
<tr>
<td>currency</td><td>The instrument’s currency (USD). </td></tr>
<tr>
<td>yyyymmdd hh:mm:ss</td><td>End date for the historical data query. </td></tr>
<tr>
<td>duration amount</td><td>The number of time units for the duration time. </td></tr>
<tr>
<td>duration unit</td><td>The duration's time unit. </td></tr>
<tr>
<td>bar size</td><td>The bar size. </td></tr>
<tr>
<td>rth only</td><td>Set to 1 to obtain only data generated during regular trading hours (RTH), or set to 0 to get all data generated during and outside of of RTH. </td></tr>
<tr>
<td>what to show</td><td>The type of data: MIDPOINT, TRADES, BID, ASK, etc. </td></tr>
<tr>
<td>data format</td><td>Set to 1 to format the resulting bars’ date as yyyymmss hh:mm:ss. Set to 2 to express the resulting bars’ time as the number of seconds since 1970. </td></tr>
</table>
<h2><a class="anchor" id="how_to_handle_spaces_and_colons"></a>
How to Handle Spaces and Colons in the Formula</h2>
<p>Our DDE links cannot contain certain special characters such as spaces or colons, but you will need to use these characters in your DDE formula. To overcome this limitation, we have provided keywords that you can use in place of the actual special character: singleSpace and singleColon. For example, if you want to specify an end date and time such as March 2, 2015 at 23:59:59 in the format specified above, you would then enter:</p>
<p><b>20150302 23:59:59</b></p>
<p>This translates into:</p>
<p>20150302<b>singleSpace</b>23<b>singleColon</b>59<b>singleColon</b>59</p>
<p>This applies to all cases in which you need spaces or colons in the DDE formula. This is particularly important when describing futures or options contracts because you can then use their local symbols, which often include spaces. For example, the DBK futures contract expiring on May 2015 has a local symbol <b>DBKG MAY 15</b> which you would provide as:</p>
<p>DBKG<b>singleSpace</b>MAY<b>singleSpace</b>15</p>
<h2><a class="anchor" id="enter_hst_request"></a>
Enter the Historical Data Request</h2>
<p>Let's continue with our historical data request. As an example, try to pull MIDPOINT historical data for the EUR.USD currency pair prior to February 27th 2015 at 23:59:59 in thirty minutes bars (9), for a duration of one day (1 D). The correct formula for this request is:</p>
<p>=S<b>sample123</b>|hist!'id<b>4</b>?req?<b>EUR_CASH_IDEALPRO_USD_~</b>/<b>20150227</b>singleSpace<b>23</b>singleColon<b>59</b>singleColon<b>59</b>_<b>1</b>singleSpace<b>D</b>_<b>9</b>_<b>MIDPOINT</b>_<b>1</b>_<b>1</b>'</p>
<p>Copy the above formula into an empty cell in your Excel worksheet. Notice that the cell displays PROCESSING, which, if everything proceeds without error, will change into RECEIVED”:</p>
<div class="image">
<img src="dde_hst_prepare.png" alt="dde_hst_prepare.png"/>
</div>
<p>At this point, you have just told TWS that you want our EUR.USD historical data and TWS replied that the data has been received from the server and is ready to be viewed.</p>
<p>This is where the process becomes slightly complicated because, unlike real time market data, where each incoming price is obtained using a very specific formula, you will not fetch each bar one by one with a formula (this is quite fortunate since we could be expecting hundreds of bars!). Instead, you will read all the bars together using a single DDE request and then display them in your worksheet with the help of some VBA code. For purposes of simplicity, we will keep the coding to minimum.</p>
<p>In the next steps, we will briefly describe how to add a button to a spreadsheet for the sake of completeness but remember that it is out of the scope of IB's support to provide any assistance on using Excel.</p>
<h1><a class="anchor" id="dde_hst_receive"></a>
Receiving the data</h1>
<ul>
<li><a class="el" href="dde_hst_receive_add_a_button.html">Receiving the Data - Add a Button</a></li>
<li><a class="el" href="dde_hst_receive_add_the_code.html">Receiving the Data - Add the Code</a></li>
</ul>
<h1><a class="anchor" id="dde_hst_understanding"></a>
Understanding the Formula</h1>
<p>To understand the formulas' syntax, please refer to the <a class="el" href="dde_reference.html#dde_hst">Historical Data</a> section from the <a class="el" href="dde_reference.html">DDE Formula Reference</a> page.</p>
<p>For more contract definition samples via DDE, please refer to <a class="el" href="dde_reference.html#dde_contracts_description">How to Find the Definition of a Contract</a> .</p>
<p><br />
<br />
 </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.4-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">This website uses cookies. By navigating through it you agree to the use of cookies. Copyright Interactive Brokers 2016 </li>
  </ul>
</div>
<!--BEGIN GCS_SEARCHBOX-->
<style type='text/css'>
	.gsc-control-cse{
		font family: Arial, sans-serif;
		border-color: #000100;
		background-color: #000000;
		width:260px;
		height: 20px;
		padding-top: 6px;
	}
	input.gsc-search-button {
		background-color: #6D1800;
		color: #fff;
		cursor: pointer;
	}
	input.gsc-search-button:hover {
		background-color: #A02200;
	}
	td.gsc-clear-button {
		position: relative;
		right: 85px;
	}
  }
</style>
<!--END GCS_SEARCHBOX-->
</body>
</html>
