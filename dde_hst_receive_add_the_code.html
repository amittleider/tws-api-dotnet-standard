<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>TWS API v9.72+: Receiving the Data - Add the Code</title>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="https://www.interactivebrokers.com/favicon.ico" rel="shortcut icon">
<script>
$(document).ready(function(){
		var picked=getCookie("picked");
		if (picked != "") {
			if (!$(this).hasClass("active")) {
				var tabNum = $(this).index();
				var nthChild = picked;
				$("ul#tabs li.active").removeClass("active");
				$(this).addClass("active");
				$("ul#tab li.active").removeClass("active");
				$("ul#tab li:nth-child("+nthChild+")").addClass("active");
				$("ul#tabs li:nth-child("+nthChild+")").addClass("active");
				setCookie("picked", nthChild, 1);
			}
		}
		$("ul#tabs li").click(function(e){
			if (!$(this).hasClass("active")) {
			var tabNum = $(this).index();
			var nthChild = tabNum+1;
			$("ul#tabs li.active").removeClass("active");
			$(this).addClass("active");
			$("ul#tab li.active").removeClass("active");
			$("ul#tab li:nth-child("+nthChild+")").addClass("active");
			setCookie("picked", nthChild, 1);
		}
    });
});
function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
} 
function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
} 
function checkCookie() {
    var picked=getCookie("picked");
    if (picked != "") {
        alert("Welcome again " + picked);
    }else{
        //username = prompt("Please enter your name:", "");
        if (picked != "" && picked != null) {
            setCookie("picked", 1, 365);
        }
    }
}
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ib_theme.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" style="background-color:black;">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr>
  <td id="projectlogo"><img alt="Logo" src="nav_iblogo.png"/></a></td>
  <td style="padding: 0 0 0 1em;">
   <ul id="tabs"><li class="active">C#</li><li>Java</li><li>VB</li><li>C++</li><li>Python</li></ul>
  </td>
  <td><a href="https://www.interactivebrokers.com/en/index.php?f=customerService&p=email" style="color:#C7C7C7;font-weight:bold;padding: 0 0 0 1em;">Contact us</a></td>
  <!--BEGIN GCS_SEARCHBOX-->
  <td style="position: absolute; right: 0;">
   <div id="google-custom-search" align="right" style="vertical-align: top;">
   <script>
  (function() {
    var cx = '015239726745168389685:6_uymb577ei';
	var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
	</script>
	<gcse:search newWindow="false" enableHistory="true"></gcse:search>
   </div>
   </td>
  <!--END !GCS_SEARCHBOX-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dde_hst_receive_add_the_code.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Receiving the Data - Add the Code </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here are the routines which will finally obtain the data from the TWS: </p>
<pre class="fragment">Sub fetchHistoricalData()

    'This variable will store the incoming data

    Dim TheArray() As Variant

    'Fetch the data from the TWS...

    '(Replace sample123 with your own TWS username!)

    TheArray = getData("Ssample123", "hist", "id4?result")

    '... and pass the result into another function which will populate the sheet

    Call populate(TheArray)

End Sub
</pre><hr/>
 <pre class="fragment">'This function triggers a DDE request and returns its response

Function getData(serverName, topic, request)

    Dim chan As Integer

    'Initiate the DDE channel

    chan = Application.DDEInitiate(serverName, topic)

    'Perform the request

    getData = Application.DDERequest(chan, request)

    'Terminate the channel

    Application.DDETerminate chan

End Function
</pre><hr/>
 <pre class="fragment">'Populate our blank sheet with the incoming data

Sub populate(ByRef TheArray() As Variant)

'Watch out for empty possible errors and handle properly.

On Error GoTo ErrHandler

    For i = 1 To UBound(TheArray)

        Range("F" &amp; i + 1).Value = TheArray(i, 1)

        Range("G" &amp; i + 1).Value = TheArray(i, 2)

        Range("H" &amp; i + 1).Value = TheArray(i, 3)

        Range("I" &amp; i + 1).Value = TheArray(i, 4)

        Range("J" &amp; i + 1).Value = TheArray(i, 5)

        Range("K" &amp; i + 1).Value = TheArray(i, 6)

        Range("L" &amp; i + 1).Value = TheArray(i, 7)

        Range("M" &amp; i + 1).Value = TheArray(i, 8)

        Range("N" &amp; i + 1).Value = TheArray(i, 9)

    Next

ErrHandler:

    Exit Sub

End Sub
</pre><p>The fetchHistoricalData method invokes the getData function passing in:</p>
<ul>
<li>The DDE server name, which is your TWS username prefixed with a capital S</li>
<li>The DDE “topic” for historical data: “hist”</li>
<li>A third parameter which is just the remaining fragment of the DDE link: id[requestId]?result</li>
</ul>
<p>The third parameter contains the request ID you used in the requesting formula (4). Remember this same procedure from the previous tutorial when you requested real time data. Your request/retrieve formulas both need to include the exact same ID.</p>
<p>If you correctly entered the code into your macro in the VBA editor as shown above, your Excel worksheet should look very similar to the image below. (Note that we have changed the button label to <b>Historical</b> from its default value).</p>
<div class="image">
<img src="dde_hst_add_the_code.png" alt="dde_hst_add_the_code.png"/>
</div>
<p>Just after the data is retrieved from TWS, the requesting formula will change its output to FINISHED.</p>
<p>It is very important for to wait until the request formula’s output changes from PROCESSING to RECEIVED before you try to pull the actual data from TWS. If the cell displays PROCESSING for too long, then it is very likely there was an error in your request. If this happens, make use of the error retrieval formulas explained in <a class="el" href="dde_realtime_tutorial.html#obtain_last_error_msg">Obtain the Last Available Error</a>.</p>
<p>The next step is to <a class="el" href="dde_reference.html#dde_hst">Understand the Formula</a>.</p>
<p><br/>
<br/>
 </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.4-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">This website uses cookies. By navigating through it you agree to the use of cookies. Copyright Interactive Brokers 2016 </li>
  </ul>
</div>
<!--BEGIN GCS_SEARCHBOX-->
<style type='text/css'>
	.gsc-control-cse{
		font family: Arial, sans-serif;
		border-color: #000100;
		background-color: #000000;
		width:260px;
		height: 20px;
		padding-top: 6px;
	}
	input.gsc-search-button {
		background-color: #6D1800;
		color: #fff;
		cursor: pointer;
	}
	input.gsc-search-button:hover {
		background-color: #A02200;
	}
	td.gsc-clear-button {
		position: relative;
		right: 85px;
	}
  }
</style>
<!--END GCS_SEARCHBOX-->
</body>
</html>
